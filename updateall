#!/bin/bash
echo "-----------------------------------"
echo "updateall v.2.1 for Debian & Ubuntu"
echo "-----------------------------------"

# Run this as a normal user. Your admin password will be asked for when required.
# This version adds resilient error handling and conditional checks.

set -uo pipefail  # keep unset var + pipefail safety, custom handler replaces -e

# Helper to run a step and continue on error
run() {
    local desc="$1"; shift
    echo "==> $desc"
    if "$@"; then
        echo "✓ $desc succeeded"
    else
        local rc=$?
        echo "⚠ $desc failed (exit $rc); continuing"
    fi
}

# Warn if running as root
if [ "$(id -u)" -eq 0 ]; then
    echo "⚠ Warning: Script is running as root; recommended to run as normal user."
fi

echo "--- APT maintenance ---"
run "APT update" sudo apt-get update
run "APT upgrade" sudo apt-get upgrade -y
run "APT full-upgrade" sudo apt-get full-upgrade -y
run "APT autoremove" sudo apt-get autoremove -y

# Purge old kernels if tool exists
if command -v purge-old-kernels &> /dev/null; then
    run "Purge old kernels" sudo purge-old-kernels -y
else
    echo "(skip) purge-old-kernels not installed"
fi

echo "--- Snap updates (conditional) ---"
if command -v snap &> /dev/null; then
    run "Snap refresh" sudo snap refresh
else
    echo "(skip) snapd not installed"
fi

echo "--- Flatpak updates (conditional) ---"
if command -v flatpak &> /dev/null; then
    if [ -n "${SSH_CONNECTION:-}" ] || [ -n "${SSH_CLIENT:-}" ]; then
        run "Flatpak update (SSH with sudo)" sudo flatpak update -y
    else
        run "Flatpak update" flatpak update -y
    fi
else
    echo "(skip) flatpak not installed"
fi

echo "--- Multipass containers (optional) ---"
# Uncomment if you want these managed automatically.
# if command -v multipass &> /dev/null; then
#     run "Multipass start ubuntu-lts" multipass start ubuntu-lts
#     run "Multipass update in ubuntu-lts" multipass exec ubuntu-lts updateall
#     run "Multipass stop ubuntu-lts" multipass stop ubuntu-lts
# else
#     echo "(skip) multipass not installed"
# fi

echo "All steps attempted. Script finished."
